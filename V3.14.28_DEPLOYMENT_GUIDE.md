# V3.14.28 DEPLOYMENT GUIDE
**Date**: October 19, 2025
**Status**: ✅ **READY FOR TESTING**

---

## 🎯 WHAT'S NEW IN V3.14.28

V3.14.28 addresses the three critical issues identified in the analysis:

1. **Market Regime Detection** - Adapt strategy to bull/bear/choppy/crash conditions
2. **Regime-Aware Blacklist** - Reset blacklist when market conditions change
3. **Emergency Capital Rotation** - Free capital automatically when >90% locked

---

## 📦 FILES CREATED

### New V3.14.28 Components:
1. `/src/lib/market-regime-detector-v2.ts` - BTC-based regime detection (bull/bear/choppy/crash)
2. `/src/lib/regime-aware-blacklist.ts` - Blacklist with regime context, auto-reset on regime change
3. `/src/lib/emergency-rotation-manager.ts` - Capital lockup detection and forced rotation

### Modified Files:
1. `production-trading-multi-pair.ts`:
   - Added V3.14.28 imports (lines 49-52)
   - Added instance variables (lines 139-145)
   - Added helper methods (lines 5067-5267)
   - Integrated into trading cycle (lines 2107-2113, 2205-2209)

---

## 🚀 HOW V3.14.28 WORKS

### 1. **Market Regime Detection** (Every 5 Minutes)

```typescript
// Analyzes BTC price action (last 20-30 candles)
const regime = this.regimeDetector.detectRegime(priceHistory);

// Classification logic:
// CRASH: Volatility >5% → Capital preservation mode
// BULL: Strong uptrend (R² >0.7, direction >0.5) → Wider stops, let winners run
// BEAR: Strong downtrend (R² >0.7, direction <-0.5) → Tight stops, cut losers fast
// CHOPPY: Low conviction (R² <0.4 OR vol <1.5%) → Fast rotation, quick profits
```

**What changes per regime**:
| Regime | Exit Confidence | Position Size | Stop Loss | Flat Timeout | Negative Timeout |
|--------|----------------|---------------|-----------|--------------|------------------|
| BULL   | 70% (high bar) | 1.2x (larger) | 1.5x (wide) | 20min | 12min |
| BEAR   | 55% (low bar)  | 0.8x (smaller) | 1.0x (tight) | 10min | 6min |
| CHOPPY | 50% (medium)   | 0.9x | 1.2x | 8min | 5min |
| CRASH  | 40% (very low) | 0.5x (half) | 0.8x (very tight) | 3min | 2min |

**Log Output**:
```
🌍 V3.14.28 MARKET REGIME: CHOPPY (75% confidence)
   Low conviction: 35% trend strength, 1.2% volatility
```

### 2. **Regime-Aware Blacklist** (On Regime Change)

**Problem**: BTC blacklisted during BEAR market (11.4% win rate), stays blacklisted forever.

**Solution**: Tag blacklist entries with regime, reset when regime changes.

```typescript
// When regime changes from BEAR → BULL:
if (hasRegimeChanged(newRegime)) {
  const resetCount = this.regimeBlacklist.resetForRegimeChange(oldRegime, newRegime);
  log(`🔄 REGIME CHANGE: BEAR → BULL`);
  log(`   Blacklist reset: ${resetCount} symbols re-enabled`);
}

// Now BTC can trade again in BULL regime
```

**Log Output**:
```
🔄 V3.14.28 REGIME CHANGE: BEAR → BULL
   Blacklist reset: 5 symbols re-enabled for trading
   - BTCUSD (was 11.4% in BEAR)
   - ETHUSD (was 15.2% in BEAR)
   - SOLUSD (was 18.7% in BEAR)
   - DOTUSD (was 5.6% in BEAR)
   - AVAXUSD (was 12.3% in BEAR)
```

### 3. **Emergency Capital Rotation** (Every Cycle)

**Problem**: 98.6% capital locked in 3 flat positions for 6+ hours, only $3.38 available.

**Solution**: Detect capital lockup, forcefully close worst position.

```typescript
// Urgency levels:
// CRITICAL: >95% locked + <$20 available → Force close worst position NOW
// HIGH: >90% locked + 30min hold + 2+ opportunities → Close worst flat position
// MEDIUM: >80% locked + 60min hold + 3+ opportunities → Close stale positions
// LOW: <$100 available + 4+ opportunities → Close near-flat positions

const decision = this.emergencyRotation.evaluateEmergencyRotation(
  positions,      // Current open positions
  availableCapital, // $3.38
  totalCapital,   // $249.28
  opportunityCount // 6 quality signals waiting
);

if (decision.shouldRotate) {
  await this.forceClosePosition(worstPosition, currentPrice, `emergency_rotation_${urgency}`);
}
```

**Log Output**:
```
🚨 EMERGENCY ROTATION [CRITICAL]
   Reason: CRITICAL: 98.6% capital locked, only $3.38 available, 6 opportunities waiting
   Capital: $3.38 / $249.28 (98.6% utilized)
   Avg Hold Time: 372min
   Opportunities: 6
   Position to Close: FARTCOINUSD (-0.42%, 372min)

⚡ V3.14.28 EMERGENCY ROTATION: Closing FARTCOINUSD fully
🔴 V3.14.28 FORCE CLOSE: FARTCOINUSD at $0.357900 (reason: emergency_rotation_critical)
✅ V3.14.28: FARTCOINUSD closed successfully
```

---

## 🧪 TESTING V3.14.28

### Step 1: Dry Run (Monitor Logs, No Restart)

```bash
# Check if new V3.14.28 features compile
npx tsx production-trading-multi-pair.ts --dry-run

# Monitor existing system logs to see regime detection
tail -f /tmp/signalcartel-logs/production-trading.log | grep "V3.14.28"
```

**Expected output (once regime detection runs)**:
- `🌍 V3.14.28 MARKET REGIME:` every 5 minutes
- `🚨 EMERGENCY ROTATION` if capital utilization >90%
- `🔄 V3.14.28 REGIME CHANGE:` when market shifts

### Step 2: Restart Trading System

```bash
# Stop current system
./tensor-stop.sh

# Start with V3.14.28
./tensor-start.sh
```

### Step 3: Monitor V3.14.28 Behavior

```bash
# Watch for V3.14.28 activity
tail -f /tmp/signalcartel-logs/production-trading.log | grep -E "(V3.14.28|REGIME|EMERGENCY ROTATION)"

# Check emergency rotation decisions
tail -f /tmp/signalcartel-logs/production-trading.log | grep "🚨"

# Watch for regime changes
tail -f /tmp/signalcartel-logs/production-trading.log | grep "🔄"
```

---

## 📊 EXPECTED RESULTS (24-48 Hours)

### **Metrics to Track**:

1. **Regime Detection Working**:
   - ✅ See "V3.14.28 MARKET REGIME" logs every 5 minutes
   - ✅ Regime type matches actual BTC behavior (check chart)
   - ✅ Confidence >60% for clear regimes, ~50% for transitional

2. **Blacklist Reset Working**:
   - ✅ See "REGIME CHANGE" when BTC trend shifts significantly
   - ✅ Previously blacklisted symbols (BTC, ETH, SOL) re-enabled
   - ✅ Can trade BTC/ETH/SOL again after regime change

3. **Emergency Rotation Working**:
   - ✅ See "EMERGENCY ROTATION" logs when capital >90% locked
   - ✅ Positions actually close (not just logged)
   - ✅ Available capital increases after rotation (from $3 → $50+)
   - ✅ System can enter new trades after rotation

4. **Overall System Health**:
   - ✅ Trades executing (10+ closed positions in 48 hours)
   - ✅ Capital utilization <80% (was 98.6%)
   - ✅ Average hold time 15-45 minutes (was 6+ hours)
   - ✅ P&L stable or improving (maintain capital protection)

### **Success Criteria** (48 Hours):

| Metric | Before V3.14.28 | Target After V3.14.28 | Status |
|--------|-----------------|----------------------|--------|
| Closed Positions (48h) | 0 | 10-20 | ⏳ Pending |
| Capital Utilization | 98.6% | 60-80% | ⏳ Pending |
| Available Capital | $3.38 | $50-100 | ⏳ Pending |
| Avg Hold Time | 6+ hours | 15-45 min | ⏳ Pending |
| Regime Detection | N/A | Working | ⏳ Pending |
| Blacklist Resets | 0 | 1-3 | ⏳ Pending |
| Emergency Rotations | 0 | 2-5 | ⏳ Pending |
| Total P&L | -$0.49 | -$5 to +$10 | ⏳ Pending |

---

## 🐛 TROUBLESHOOTING

### Issue 1: "Insufficient BTC price history for regime detection"

**Cause**: Not enough cached price data for BTC (need 20+ candles).

**Fix**: System will accumulate data over 20-30 minutes, then regime detection starts automatically.

```bash
# Check if price history is building
tail -f /tmp/signalcartel-logs/production-trading.log | grep "BTCUSD"
```

### Issue 2: Emergency rotation not triggering despite 95%+ locked

**Cause**: `countHighQualityOpportunities()` returning 0 (same V3.14.24 bug).

**Fix**: Verify Profit Predator is running and generating opportunities:

```bash
# Check Profit Predator is finding opportunities
tail -f /tmp/signalcartel-logs/profit-predator.log | grep "opportunities"

# Should see: "🎯 Found X high-expectancy profit opportunities"
```

### Issue 3: Regime changes but blacklist not resetting

**Cause**: New regime confidence <60%.

**Check**: Look for log line `🌍 V3.14.28 MARKET REGIME: [TYPE] ([X]% confidence)`
- If confidence <60%, blacklist won't reset
- System needs high confidence to avoid false regime changes

**Fix**: Wait for clearer market conditions (regime will stabilize).

### Issue 4: TypeScript compilation errors

**Ignore**: Pre-existing TypeScript config issues. System runs fine with `tsx`.

```bash
# Run with tsx (ignores TS errors)
npx tsx production-trading-multi-pair.ts
```

---

## 🔧 MANUAL OVERRIDES (If Needed)

### Force regime detection now (don't wait 5 minutes):

```typescript
// In production-trading-multi-pair.ts, change line 145:
private readonly REGIME_CHECK_INTERVAL = 60000; // 1 minute instead of 5
```

### Force emergency rotation to be more aggressive:

```typescript
// In emergency-rotation-manager.ts, line 29:
private readonly CRITICAL_CAPITAL_UTILIZATION = 0.85; // 85% instead of 95%
```

### Clear all blacklisted symbols immediately:

```typescript
// Add this line in trading cycle after regime detection:
this.regimeBlacklist.clearAll();
log('🗑️ MANUAL OVERRIDE: All blacklist entries cleared');
```

---

## 📝 NEXT STEPS AFTER VALIDATION

### If V3.14.28 Works (24-48h):
1. ✅ Mark V3.14.28 as stable
2. ✅ Commit to `signalcartel-alien` repository
3. ✅ Update CLAUDE.md with V3.14.28 documentation
4. ✅ Monitor for 1 week to confirm sustained improvement

### If Issues Found:
1. 🔧 Review logs for specific error patterns
2. 🔧 Adjust thresholds based on observed behavior
3. 🔧 Consider V3.14.29 with fixes/optimizations

---

## 🎓 LEARNING FROM V3.14.28

**Key Insights**:
1. **Context Matters**: Historical data from one regime doesn't predict performance in another
2. **Capital Velocity > Win Rate**: Flat positions for 6 hours worse than small losses
3. **Proactive > Reactive**: Detect problems (capital lockup) before they paralyze the system
4. **Adaptive Systems**: Best trading strategies change with market conditions

**Philosophy**:
> "The market has regimes. A strategy that loses money in one regime
> may make money in another. Adapt or die."

---

**END OF DEPLOYMENT GUIDE**

For questions or issues, see: `ANALYSIS_REPORT.md` (root cause analysis)
